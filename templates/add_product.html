<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>Додати виріб</title>
  <link rel="stylesheet" href="../static/styles/add_product_styles.css">
</head>
<body>
<header>
  <div class="nav-container">
    <a href="{{ url_for('home') }}"><img src="../static/icons/home.png" alt="На головну" class="tab-link-icon"></a>
    <a href="{{ url_for('home') }}" class="tab-link">На головну</a>
  </div>
  <div class="account-info">
    <p>Адміністратор</p>
    <img src="../static/icons/account.png" alt="Адміністратор">
  </div>
</header>

<main class="main-container">
  <div class="left-panel">
    <form id="productForm" method="POST" action="/add_product">
      <input type="text" name="productName" id="productName" placeholder="Введіть назву виробу">
      <button type="submit" class="add-btn"><img src="../static/icons/plus.png">Додати виріб</button>
    </form>

    <div id="hierarchyContainer">
      {% if product %}
        <div class="product-wrapper">
          <div class="item-row">
            <div class="product" onclick="loadOperations({{ product.id }}, 'product')">{{ product.name }}</div>
            <a href="javascript:void(0);" class="add-btn side-btn" onclick="addBlock({{ product.id }})">
              <img src="../static/icons/plus.png">Додати блок
            </a>
          </div>

          {% for block in product.blocks %}
            <div class="block-wrapper">
              <div class="item-row">
                <div class="block" onclick="loadOperations({{ block.id }}, 'block')">{{ block.name }}</div>
                <a href="javascript:void(0);" class="add-btn side-btn" onclick="addDetail({{ block.id }})">
                  <img src="../static/icons/plus.png">Додати деталь
                </a>
              </div>

              {% for detail in block.details %}
                <div class="item-row">
                  <div class="detail" onclick="loadOperations({{ detail.id }}, 'detail')">{{ detail.name }}</div>
                </div>
              {% endfor %}
            </div>
          {% endfor %}
        </div>
      {% endif %}
    </div>
  </div>

  <div class="right-panel">
    <!-- Динамічно заповнюється через JavaScript -->
  </div>
</main>

<script>
const typeMap = {
  product: 'Продукт',
  block: 'Блок',
  detail: 'Деталь'
};

function addBlock(productId) {
  const blockName = prompt("Введіть назву блоку:");
  if (blockName) {
    fetch(`/add_block/${productId}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ block_name: blockName })
    }).then(res => {
      if (res.ok) location.reload();
      else alert("Не вдалося додати блок.");
    });
  }
}

function addDetail(blockId) {
  const detailName = prompt("Введіть назву деталі:");
  if (detailName) {
    fetch(`/add_detail/${blockId}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ detail_name: detailName })
    }).then(res => {
      if (res.ok) location.reload();
      else alert("Не вдалося додати деталь.");
    });
  }
}

function loadOperations(componentId, componentType) {
  fetch(`/get_operations/${componentType}/${componentId}`)
    .then(response => response.json())
    .then(data => {
      const panel = document.querySelector('.right-panel');
      const translatedType = typeMap[componentType] || componentType;
      panel.innerHTML = `
          <h3>${translatedType}: ${data.component_name}</h3>
          <div class="operations-list">
            ${data.operations.map(op => `
              <div class="product-line">
                <div class="product-info">
                  <p>Назва: ${op.name}</p>
                </div>
                <div class="operations">
                  <a href="/edit_operation/${op.id}" class="icon-btn">
                    <img src="../static/icons/edit.png" alt="Редагувати">
                  </a>
                  <button class="icon-btn delete-operation-btn" data-operation-id="${op.id}" data-component-type="${componentType}" data-component-id="${componentId}" title="Видалити">
                      <img src="../static/icons/delete.png" alt="Видалити">
                    </button>

                </div>
              </div>
            `).join('')}
          </div>
          <div class="operation-footer">
            <a href="/add_operation/${componentId}?type=${componentType}" class="add-btn">
              <img src="../static/icons/plus.png">Додати операцію
            </a>
          </div>
        `;
    });
}
document.addEventListener('click', function(event) {
  if (event.target.closest('.delete-operation-btn')) {
    const btn = event.target.closest('.delete-operation-btn');
    const operationId = btn.getAttribute('data-operation-id');
    const componentType = btn.getAttribute('data-component-type');
    const componentId = btn.getAttribute('data-component-id');

    if (confirm('Ви впевнені, що хочете видалити операцію?')) {
      fetch(`/delete_operation/${operationId}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
          component_type: componentType,
          component_id: componentId
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === 'success') {
          // Видаляємо рядок з операцією з DOM
          const operationDiv = btn.closest('.product-line');
          if (operationDiv) operationDiv.remove();
          alert('Операцію успішно видалено');
        } else {
          alert('Помилка при видаленні операції');
        }
      })
      .catch(() => alert('Сталася помилка при з\'єднанні з сервером'));
    }
  }
});


</script>

</body>
</html>
