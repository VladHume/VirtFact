<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>Призначити завдання</title>
    <link rel="stylesheet" href="../static/styles/assign_task_styles.css">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@600&display=swap" rel="stylesheet">
</head>
<body>

<header>
    <div class="nav-container">
        <a href="{{ url_for('home') }}"><img src="../static/icons/home.png" alt="На головну" class="tab-link-icon"></a>
        <a href="{{ url_for('home') }}" class="tab-link">На головну</a>
    </div>
    <div class="account-info">
        <p>Адміністратор</p>
        <img src="../static/icons/account.png" alt="Адміністратор">
    </div>
</header>

<main class="main-container">
    <div class="left-panel">
        <div id="hierarchyContainer">
      {% if product %}
        <div class="product-wrapper">
          <div class="item-row">
            <div class="product" onclick="renderOperations({{ product.id }}, 'product', {{ admin_task.id }})">{{ product.name }}</div>
          </div>

          {% for block in product.blocks %}
            <div class="block-wrapper">
              <div class="item-row">
                <div class="block" onclick="renderOperations({{ block.id }}, 'block', {{ admin_task.id }})">{{ block.name }}</div>
              </div>

              {% for detail in block.details %}
                <div class="item-row">
                  <div class="detail" onclick="renderOperations({{ detail.id }}, 'detail', {{ admin_task.id }})">{{ detail.name }}</div>
                </div>
              {% endfor %}
            </div>
          {% endfor %}
        </div>
      {% endif %}
    </div>
  </div>

    </div>

    <div class="right-panel" id="operationPanel">


    </div>
</main>

<div class="btn-container">
    <button class="confirm-btn" id="confirmBtn" onclick="location.href='{{ url_for('home') }}'">Готово</button>
</div>

<div class="modal" id="assignModal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h3>Оберіть працівника</h3>
        <input type="text" id="searchInput" placeholder="Пошук працівника..." oninput="filterEmployees()">
        <div id="employeeList" class="employee-list">
            <!-- Список працівників буде тут -->
        </div>
        <button class="confirm-btn" onclick="confirmAssignment()">Підтвердити</button>
    </div>
</div>
<script>
    const operationPanel = document.getElementById("operationPanel");

    const typeMap = {
        product: 'Продукт',
        block: 'Блок',
        detail: 'Деталь'
    };

    let selectedComponent = {
        id: null,
        type: null
    };

    let selectedOperation = null;
    let selectedEmployee = null;
    let adminTask = {{ admin_task.id if admin_task else 'null' }};

    const modal = document.getElementById("assignModal");
    const employeeListEl = document.getElementById("employeeList");
    const employees = {{ employees | tojson }};
    const assignedTasksList = {{ task_map | tojson }};

    // Створюємо мапу для швидкого пошуку завдань за ключем [operation_id, component_type, component_id]
    const assignedTasks = {};
    assignedTasksList.forEach(t => {
        const key = JSON.stringify([t.operation_id, t.component_type, t.product_id]);
        assignedTasks[key] = {
            employee_name: getEmployeeNameById(t.responsible_id) || 'Невідомий'
        };
    });

    // Функція для пошуку імені працівника по id
    function getEmployeeNameById(id) {
        const emp = employees.find(e => e.id === id);
        return emp ? emp.name : null;
    }

    function renderOperations(componentId, componentType, aTaskId) {
        selectedComponent.id = componentId;
        selectedComponent.type = componentType;
        adminTask = aTaskId;

        fetch(`/get_operations/${componentType}/${componentId}`)
            .then(response => response.json())
            .then(data => {
                const panel = document.querySelector('.right-panel');
                const translatedType = typeMap[componentType] || componentType;

                panel.innerHTML = `
                    <h3>${translatedType}: ${data.component_name}</h3>
                    <div class="operations-list">
                        ${data.operations.map(op => {
                            const key = JSON.stringify([op.id, componentType, componentId]);
                            const assigned = assignedTasks[key];
                            const label = assigned ? `Призначено: ${assigned.employee_name}` : "Призначити";
                            const style = assigned ? 'background-color: #cccccc;' : '';
                            return `
                                <div class="product-line">
                                    <div class="product-info">
                                        <p>Назва: ${op.name}</p>
                                    </div>
                                    <div class="operations">
                                        <button class="assign-btn" onclick="openModal(${op.id})" style="${style}">${label}</button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            });
    }

    function openModal(operationId) {
        selectedOperation = operationId;
        selectedEmployee = null;
        renderEmployees(employees);
        modal.style.display = "block";
    }

    function closeModal() {
        modal.style.display = "none";
        selectedEmployee = null;
    }

    function renderEmployees(list) {
        employeeListEl.innerHTML = list.map(emp => `
            <div class="employee-item" data-id="${emp.id}" onclick="selectEmployee(this)">
                ${emp.name}
            </div>
        `).join('');
    }

    function selectEmployee(el) {
        document.querySelectorAll('.employee-item').forEach(item => item.style.backgroundColor = '');
        el.style.backgroundColor = '#e0eaff';
        selectedEmployee = {
            id: el.dataset.id,
            name: el.textContent
        };
    }

    function confirmAssignment() {
        if (!selectedEmployee) {
            alert("Будь ласка, оберіть працівника.");
            return;
        }

        if (!selectedOperation || !selectedComponent.id || !selectedComponent.type) {
            alert("Помилка: не обрано компонент або операцію.");
            return;
        }

        fetch('/create_task', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                operation_id: selectedOperation,
                employee_id: selectedEmployee.id,
                component_id: selectedComponent.id,
                component_type: selectedComponent.type,
                admin_task: adminTask
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.message) {
                const key = JSON.stringify([selectedOperation, selectedComponent.type, selectedComponent.id]);
                assignedTasks[key] = { employee_name: selectedEmployee.name };

                // Оновити текст і стиль кнопки
                const buttons = document.querySelectorAll('.assign-btn');
                buttons.forEach(btn => {
                    // Перевіряємо по operationId у onclick
                    if (btn.getAttribute("onclick")?.includes(selectedOperation)) {
                        btn.textContent = `Призначено: ${selectedEmployee.name}`;
                        btn.style.backgroundColor = "#cccccc";
                        // Кнопку не блокуємо (за бажанням)
                    }
                });

                alert(`Операцію призначено працівнику "${selectedEmployee.name}".`);
                closeModal();
            } else {
                alert("Помилка: " + (data.error || "Невідома помилка"));
            }
        });
    }

    function filterEmployees() {
        const query = document.getElementById("searchInput").value.toLowerCase();
        const filtered = employees.filter(emp => emp.name.toLowerCase().includes(query));
        renderEmployees(filtered);
    }

    window.onclick = function(event) {
        if (event.target === modal) {
            closeModal();
        }
    }

    window.onload = () => {
        {% if product %}
            renderOperations({{ product.id }}, 'product', {{ admin_task.id }});
        {% endif %}
    };
</script>

</body>
</html>
