<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>{% if edit_mode %}–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –æ–ø–µ—Ä–∞—Ü—ñ—é{% else %}–î–æ–¥–∞—Ç–∏ –æ–ø–µ—Ä–∞—Ü—ñ—é{% endif %}</title>
    <link rel="stylesheet" href="../static/styles/add_operation_styles.css">
</head>
<body>

<header>
    <div class="nav-container">
        <a href="{{ url_for('home') }}"><img src="../static/icons/home.png" alt="–ù–∞ –≥–æ–ª–æ–≤–Ω—É" class="tab-link-icon"></a>
        <a href="{{ url_for('home') }}" class="tab-link">–ù–∞ –≥–æ–ª–æ–≤–Ω—É</a>
    </div>
    <div class="account-info">
        <img src="../static/icons/account.png" alt="–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä">
    </div>
</header>

<main class="operation-container">
    <div class="form-section">
        <h3>{{ component_name }}: {% if edit_mode %}–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –æ–ø–µ—Ä–∞—Ü—ñ—é{% else %}–î–æ–¥–∞—Ç–∏ –æ–ø–µ—Ä–∞—Ü—ñ—é{% endif %}</h3>

        <div class="select-block">
            <label for="operationName">–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –æ–ø–µ—Ä–∞—Ü—ñ—ó:</label>
            <input type="text" id="operationName" name="name" placeholder="–ù–∞–∑–≤–∞ –æ–ø–µ—Ä–∞—Ü—ñ—ó"
                   value="{{ operation.name if edit_mode else '' }}">
        </div>

        <label for="locationSelect">–û–±–µ—Ä—ñ—Ç—å –ª–æ–∫–∞—Ü—ñ—é:</label>
        <select id="locationSelect" name="location">
            {% for location in locations %}
                {% if location.id == location_id %}
                    <option value="{{ location.id }}" selected>{{ location.name }}</option>
                {% endif %}
            {% endfor %}
            {% for location in locations %}
                {% if location.id != location_id %}
                    <option value="{{ location.id }}">{{ location.name }}</option>
                {% endif %}
            {% endfor %}
        </select>

        <div class="select-block">
            <label>–í–∫–∞–∂—ñ—Ç—å —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏:</label>
            <input type="text" placeholder="–ü–æ—à—É–∫ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤..." oninput="filterCheckboxes('toolsCheckboxes', this.value)">
            <div id="toolsCheckboxes" class="checkbox-group">
                {% for tool in tools %}
                    <label>
                        <input type="checkbox" name="tools[]" value="{{ tool.id }}"
                        {% if edit_mode and tool.id in selected_tools %}checked{% endif %}>
                        {{ tool.name }}
                    </label>
                {% endfor %}
            </div>
        </div>

        <div class="select-block">
            <label>–í–∫–∞–∂—ñ—Ç—å –º–∞—Ç–µ—Ä—ñ–∞–ª–∏:</label>
            <input type="text" placeholder="–ü–æ—à—É–∫ –º–∞—Ç–µ—Ä—ñ–∞–ª—ñ–≤..." oninput="filterCheckboxes('materialsCheckboxes', this.value)">
            <div id="materialsCheckboxes" class="checkbox-group">
                {% for material in materials %}
                    <label>
                        <input type="checkbox" name="materials[]" value="{{ material.id }}"
                        {% if edit_mode and material.id in selected_materials %}checked{% endif %}>
                        {{ material.name }}
                    </label>
                {% endfor %}
            </div>
        </div>

        {% if component_type == 'block' or component_type == 'detail' %}
        <div class="select-block">
            <label>–í–∫–∞–∂—ñ—Ç—å –∑–∞–ª–µ–∂–Ω—ñ {{ '–±–ª–æ–∫–∏' if component_type == 'block' else '–¥–µ—Ç–∞–ª—ñ' }}:</label>
            <input type="text" placeholder="–ü–æ—à—É–∫..." oninput="filterCheckboxes('dependencyCheckboxes', this.value)">
            <div id="dependencyCheckboxes" class="checkbox-group">
                {% for item in dependencies %}
                    <label>
                        <input type="checkbox" name="dependencies[]" value="{{ component_type }}:{{ item.id }}"
                        {% if edit_mode and component_type ~ ':' ~ item.id|string in selected_dependencies %}checked{% endif %}>
                        {{ item.name }}
                    </label>
                {% endfor %}
            </div>
        </div>
        {% endif %}

    </div>

    <div class="instruction-section">
        <h4>–Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó:</h4>

        <div class="upload-group">
            <button type="button" onclick="uploadFile('text/pdf', 'pdfList')" class="upload-btn">üìé –ü—Ä–∏–∫—Ä—ñ–ø–∏—Ç–∏ —Ç–µ–∫—Å—Ç–æ–≤—É —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—é</button>
            <ul id="pdfList" class="file-list">
                {% if edit_mode %}
                    {% for t in text_files %}
                        <li>
                            {{ t }}
                            <span class="remove-btn" onclick="removeExistingFile('text', '{{ t }}', this)">‚ùå</span>
                        </li>
                    {% endfor %}
                {% endif %}
            </ul>
        </div>

        <div class="upload-group">
            <button type="button" onclick="uploadFile('video/mp4', 'videoList')" class="upload-btn">üìé –ü—Ä–∏–∫—Ä—ñ–ø–∏—Ç–∏ –≤—ñ–¥–µ–æ-—ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—é</button>
            <ul id="videoList" class="file-list">
                {% if edit_mode %}
                    {% for v in video_files %}
                        <li>
                            {{ v }}
                            <span class="remove-btn" onclick="removeExistingFile('video', '{{ v }}', this)">‚ùå</span>
                        </li>
                    {% endfor %}
                {% endif %}
            </ul>
        </div>

        <div class="upload-group">
            <button type="button" onclick="uploadFile('image/png', 'imageList', true)" class="upload-btn">üìé –ù–∞–¥–∞—Ç–∏ –ø—Ä–∏–∫–ª–∞–¥–∏ –≥–æ—Ç–æ–≤–æ–≥–æ –±–ª–æ–∫—É</button>
            <ul id="imageList" class="file-list">
                {% if edit_mode %}
                    {% for p in photo_files %}
                        <li>
                            {{ p }}
                            <span class="remove-btn" onclick="removeExistingFile('photo', '{{ p }}', this)">‚ùå</span>
                        </li>
                    {% endfor %}
                {% endif %}
            </ul>
        </div>

        <input type="file" id="fileInput" style="display:none" multiple>
    </div>
</main>

<div class="btn-container">
    {% if edit_mode %}
        <button class="confirm-btn" onclick="updateOperation({{ operation.id }})">–û–ù–û–í–ò–¢–ò</button>
    {% else %}
        <button class="confirm-btn" onclick="submitOperation()">–ü–Ü–î–¢–í–ï–†–î–ò–¢–ò</button>
    {% endif %}
</div>

<script>
    const fileStorage = {
        pdf: [],
        video: [],
        image: []
    };

    const deletedFiles = {
        text: [],
        video: [],
        photo: []
    };

    function uploadFile(type, listId, allowMultiple = false) {
        const input = document.getElementById("fileInput");
        input.accept = type;
        input.multiple = allowMultiple;
        input.onchange = () => {
            const list = document.getElementById(listId);
            Array.from(input.files).forEach(file => {
                const li = document.createElement("li");
                li.textContent = file.name;

                const removeBtn = document.createElement("span");
                removeBtn.textContent = "‚ùå";
                removeBtn.className = "remove-btn";
                removeBtn.onclick = () => {
                    list.removeChild(li);
                    if (listId === "pdfList") fileStorage.pdf = fileStorage.pdf.filter(f => f !== file);
                    else if (listId === "videoList") fileStorage.video = fileStorage.video.filter(f => f !== file);
                    else if (listId === "imageList") fileStorage.image = fileStorage.image.filter(f => f !== file);
                };
                li.appendChild(removeBtn);
                list.appendChild(li);

                if (listId === "pdfList") fileStorage.pdf.push(file);
                else if (listId === "videoList") fileStorage.video.push(file);
                else if (listId === "imageList") fileStorage.image.push(file);
            });
            input.value = "";
        };
        input.click();
    }

    function removeExistingFile(type, filename, el) {
        deletedFiles[type].push(filename);
        el.parentElement.remove();  // –í–∏–¥–∞–ª—è—î <li>
    }

    function getSelectedValues(name) {
        return Array.from(document.querySelectorAll(`input[name="${name}[]"]:checked`)).map(input => input.value);
    }

    function gatherFormData() {
        return {
            name: document.querySelector('#operationName').value,
            location: document.querySelector('#locationSelect').value,
            tools: getSelectedValues("tools"),
            materials: getSelectedValues("materials"),
            dependencies: getSelectedValues("dependencies")
        };
    }

    function buildFormData(data, isNew = true) {
        const formData = new FormData();
        formData.append("name", data.name);
        formData.append("location", data.location);
        data.tools.forEach(id => formData.append("tools[]", id));
        data.materials.forEach(id => formData.append("materials[]", id));
        data.dependencies.forEach(id => formData.append("dependencies[]", id));

        fileStorage.pdf.forEach(file => formData.append("texts", file));
        fileStorage.video.forEach(file => formData.append("videos", file));
        fileStorage.image.forEach(file => formData.append("photos", file));

        formData.append("deleted_files", JSON.stringify(deletedFiles));

        if (isNew) {
            formData.append("component_id", {{ component_id }});
            formData.append("product_type", "{{ component_type }}");
        }

        return formData;
    }

    function submitOperation() {
        const data = gatherFormData();
        const formData = buildFormData(data, true);

        fetch("{{ url_for('save_operation') }}", {
            method: "POST",
            body: formData
        })
        .then(response => response.json())
        .then(result => {
            if (result.status === "success") {
                alert("–û–ø–µ—Ä–∞—Ü—ñ—è –¥–æ–¥–∞–Ω–∞ —É—Å–ø—ñ—à–Ω–æ");
                window.location.href = "{{ url_for('add_product', product_id=product_id) }}";
            } else {
                alert("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –¥–æ–¥–∞–≤–∞–Ω–Ω—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó");
            }
        });
    }

    function updateOperation(id) {
        const data = gatherFormData();
        const formData = buildFormData(data, false);

        fetch(`/update_operation/${id}`, {
            method: "POST",
            body: formData
        })
        .then(response => response.json())
        .then(result => {
            if (result.status === "success") {
                alert("–û–ø–µ—Ä–∞—Ü—ñ—è –æ–Ω–æ–≤–ª–µ–Ω–∞ —É—Å–ø—ñ—à–Ω–æ");
                window.location.href = "{{ url_for('add_product', product_id=product_id) }}";
            } else {
                alert("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó");
            }
        });
    }

    function filterCheckboxes(groupId, query) {
        const checkboxes = document.getElementById(groupId).querySelectorAll("label");
        query = query.toLowerCase();
        checkboxes.forEach(label => {
            const text = label.textContent.toLowerCase();
            label.style.display = text.includes(query) ? "block" : "none";
        });
    }
</script>

</body>
</html>
